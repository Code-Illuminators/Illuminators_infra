pipeline {
    agent any

    parameters {
        choice(
            name: 'ENV',
            choices: ['stage-01', 'prod-01','dev-01'],
            description: 'Select target environment'
        )
    }

    stages {

        stage('Generate Consul Tokens & Certificates') {
            steps {
                dir("environment-setup/modules/consul") {
                    sh '''
                        echo "Generating Consul tokens for environment: $TERRAFORM_ENV"
                        export CONSUL_BOOTSTRAP_TOKEN=$(python3 -c "import uuid; print(uuid.uuid4())")
                        export GOSSIP_TOKEN=$(consul keygen)

                        envsubst < server.hcl.template > server.hcl
                        rm -rf certs
                        mkdir -p certs
                        cd certs
                        consul tls ca create
                        consul tls cert create -server dc1-server-consul-0
                       
                    '''
                }
            }
        }
 stage('Upload secrets') {
    steps {
        script {
dir("environment-setup/") {
            def consulSecrets = [
                "consul-agent-ca"         : "modules/consul/certs/consul-agent-ca.pem",
                "consul-agent-ca-key"     : "modules/consul/certs/consul-agent-ca-key.pem",
                "dc1-server-consul-0"     : "modules/consul/certs/dc1-server-consul-0.pem",
                "dc1-server-consul-0-key" : "modules/consul/certs/dc1-server-consul-0-key.pem",
                "server-hcl"              : "modules/consul/server.hcl"
            ]

            consulSecrets.each { key, filePath ->

                sh """
                ls -al
                aws secretsmanager create-secret \
                    --name "${params.ENV}/consul/${key}" \
                    --tags Key=Service,Value=consul \
                    || true
                """

                sh """
                aws secretsmanager put-secret-value \
                    --secret-id "${params.ENV}/consul/${key}" \
                    --secret-string file://${filePath}
                """
            }
        }
    }
}}
       }}
