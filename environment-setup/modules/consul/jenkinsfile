pipeline {
    agent any
    stages {
        stage('Generate Consul Tokens') {
            steps {
                 dir("environment-setup/modules/consul") {
                sh '''
                    export CONSUL_BOOTSTRAP_TOKEN=$(python3 -c "import uuid; print(uuid.uuid4())")
                    export GOSSIP_TOKEN=$(consul keygen)
                    envsubst < server.hcl.template > server.hcl
                    cat server.hcl
                    mkdir -p certs
                    cd certs
                    consul tls ca create
                    consul tls cert create -server dc1-server-consul-0
                    cat consul-agent-ca.pem
                '''
                 }
            }
        }
    }
}